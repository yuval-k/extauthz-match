services:
  # Relay Server
  relay-server:
    build:
      context: .
      dockerfile: Dockerfile.relay
    ports:
      - "9090:9090"  # Relay WebSocket
    volumes:
      - ./web/static:/web/static:ro
    networks:
      - extauth-network

  # Ext Authz Server
  authz-server:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "9000:9000"  # gRPC ext_authz service
      - "8080:8080"  # HTTP endpoint for browser URL
    networks:
      - extauth-network
    environment:
      - LOG_LEVEL=info
      - RELAY_URL=ws://relay-server:9090
      - DANGEROUS_STATIC_ENCRYPTION_KEY=true
    depends_on:
      - relay-server

  # Envoy Proxy
  envoy:
    image: envoyproxy/envoy:v1.37.0
    ports:
      - "10000:10000"  # Main proxy port (protected backend)
      - "9901:9901"    # Admin interface
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml:ro
    command: /usr/local/bin/envoy -c /etc/envoy/envoy.yaml -l info --file-flush-interval-msec 100
    depends_on:
      - authz-server
      - backend
    networks:
      - extauth-network

  # Backend Service (nginx with static page)
  backend:
    image: nginx:alpine
    ports:
      - "8081:80"  # Direct backend access (no auth)
    volumes:
      - ./backend:/usr/share/nginx/html:ro
    networks:
      - extauth-network

networks:
  extauth-network:
    driver: bridge
